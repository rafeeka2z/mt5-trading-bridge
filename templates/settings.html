{% extends "base.html" %}

{% block title %}Settings - TradingView MT5 Bridge{% endblock %}

{% block content %}
<div class="row">
    <!-- Trading Configuration -->
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i data-feather="settings"></i>
                    Trading Configuration
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('update_trading_settings') }}">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="mt5_server_ip" class="form-label">MT5 Server IP</label>
                            <input type="text" class="form-control" id="mt5_server_ip" name="mt5_server_ip" 
                                   value="{{ config.mt5_server_ip }}" placeholder="192.168.1.100">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="mt5_server_port" class="form-label">Server Port</label>
                            <input type="number" class="form-control" id="mt5_server_port" name="mt5_server_port" 
                                   value="{{ config.mt5_server_port }}" placeholder="443" min="1" max="65535">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="mt5_login" class="form-label">MT5 Login</label>
                            <input type="text" class="form-control" id="mt5_login" name="mt5_login" 
                                   value="{{ config.mt5_login }}" placeholder="12345678">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="mt5_password" class="form-label">MT5 Password</label>
                        <input type="password" class="form-control" id="mt5_password" name="mt5_password" 
                               value="{{ config.mt5_password }}" placeholder="Enter password">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="default_lot_size" class="form-label">Default Lot Size</label>
                            <input type="number" class="form-control" id="default_lot_size" name="default_lot_size" 
                                   value="{{ config.default_lot_size }}" step="0.01" min="0.01">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="max_daily_trades" class="form-label">Max Daily Trades</label>
                            <input type="number" class="form-control" id="max_daily_trades" name="max_daily_trades" 
                                   value="{{ config.max_daily_trades }}" min="1">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="max_risk_per_trade" class="form-label">Max Risk Per Trade (%)</label>
                            <input type="number" class="form-control" id="max_risk_per_trade" name="max_risk_per_trade" 
                                   value="{{ config.max_risk_per_trade }}" step="0.1" min="0.1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="slippage" class="form-label">Slippage (points)</label>
                            <input type="number" class="form-control" id="slippage" name="slippage" 
                                   value="{{ config.slippage }}" min="0">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="api_key" class="form-label">Webhook API Key</label>
                        <input type="text" class="form-control" id="api_key" name="api_key" 
                               value="{{ config.api_key }}" placeholder="webhook-api-key">
                        <div class="form-text">Use this key in TradingView webhook headers: X-API-Key</div>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="is_active" name="is_active" 
                               {% if config.is_active %}checked{% endif %}>
                        <label class="form-check-label" for="is_active">
                            Enable Trading
                        </label>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i data-feather="save"></i>
                            Save Settings
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="test-connection">
                            <i data-feather="wifi"></i>
                            Test Connection
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Webhook URL -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i data-feather="link"></i>
                    Webhook URL
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">TradingView Webhook URL</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="webhook-url" 
                               value="{{ request.url_root }}webhook" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="copy-webhook">
                            <i data-feather="copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <strong>Usage:</strong><br>
                    1. Copy the webhook URL above<br>
                    2. In TradingView, create an alert<br>
                    3. Paste the URL in the webhook field<br>
                    4. Add header: <code>X-API-Key: {{ config.api_key }}</code>
                </div>
                
                <h6>Example Alert Message:</h6>
                <pre class="bg-dark p-2 rounded"><code>{
  "symbol": "EURUSD",
  "action": "BUY",
  "price": 1.1234,
  "volume": 0.1,
  "stop_loss": 1.1200,
  "take_profit": 1.1300
}</code></pre>
            </div>
        </div>
    </div>
</div>

<!-- Symbol Configuration -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i data-feather="bar-chart"></i>
                    Symbol Configuration
                </h5>
            </div>
            <div class="card-body">
                <!-- Add Symbol Form -->
                <form method="POST" action="{{ url_for('add_symbol') }}" class="mb-4">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <input type="text" class="form-control" name="symbol" placeholder="Symbol (e.g., EURUSD)" required>
                        </div>
                        <div class="col-md-2 mb-2">
                            <input type="number" class="form-control" name="lot_size" placeholder="Lot Size" 
                                   value="0.01" step="0.01" min="0.01" required>
                        </div>
                        <div class="col-md-2 mb-2">
                            <input type="number" class="form-control" name="max_position_size" placeholder="Max Position" 
                                   value="1.0" step="0.1" min="0.1" required>
                        </div>
                        <div class="col-md-2 mb-2">
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="is_enabled" checked>
                                <label class="form-check-label">Enabled</label>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button type="submit" class="btn btn-success">
                                <i data-feather="plus"></i>
                                Add Symbol
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- Symbols Table -->
                {% if symbols %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Lot Size</th>
                                <th>Max Position</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for symbol in symbols %}
                            <tr>
                                <td><strong>{{ symbol.symbol }}</strong></td>
                                <td>{{ symbol.lot_size }}</td>
                                <td>{{ symbol.max_position_size }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if symbol.is_enabled else 'secondary' }}">
                                        {{ 'Enabled' if symbol.is_enabled else 'Disabled' }}
                                    </span>
                                </td>
                                <td>{{ symbol.created_at.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    <form method="POST" action="{{ url_for('delete_symbol', symbol_id=symbol.id) }}" 
                                          style="display: inline;" onsubmit="return confirm('Delete this symbol?')">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i data-feather="trash-2"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No symbols configured. Add a symbol above to get started.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Copy webhook URL
    document.getElementById('copy-webhook').addEventListener('click', function() {
        const webhookUrl = document.getElementById('webhook-url');
        webhookUrl.select();
        document.execCommand('copy');
        
        const button = this;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i data-feather="check"></i>';
        feather.replace();
        
        setTimeout(() => {
            button.innerHTML = originalHTML;
            feather.replace();
        }, 2000);
    });
    
    // Test connection
    document.getElementById('test-connection').addEventListener('click', function() {
        const button = this;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Testing...';
        button.disabled = true;
        
        fetch('/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Connection successful!\n\nAccount: ' + data.account_info.login + '\nServer: ' + data.account_info.server + '\nBalance: ' + data.account_info.balance);
            } else {
                alert('Connection failed: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error testing connection: ' + error.message);
        })
        .finally(() => {
            button.innerHTML = originalHTML;
            button.disabled = false;
            feather.replace();
        });
    });
});
</script>
{% endblock %}
