{% extends "base.html" %}

{% block title %}NextLevelBot Style Dashboard{% endblock %}

{% block head %}
<style>
/* NextLevelBot inspired styling */
.nlb-hero-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 4rem 0;
    margin-bottom: 3rem;
}

.nlb-counter-card {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 2rem;
    text-align: center;
    margin-bottom: 2rem;
}

.nlb-counter-number {
    font-size: 3rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.nlb-counter-label {
    font-size: 0.9rem;
    opacity: 0.8;
}

.nlb-account-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
}

.nlb-account-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(0,0,0,0.15);
}

.nlb-status-online {
    color: #28a745;
}

.nlb-status-offline {
    color: #dc3545;
}

.nlb-webhook-url {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 10px;
    font-family: monospace;
    font-size: 0.85rem;
    word-break: break-all;
}

.nlb-reality-section {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 2rem;
    margin: 2rem 0;
}

.nlb-gif-container {
    text-align: center;
    margin: 1rem 0;
}

.nlb-overview-card {
    background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
}
</style>
{% endblock %}

{% block content %}
<!-- Hero Section - NextLevelBot Style -->
<div class="nlb-hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h1 class="display-4 mb-0">üöÄ Algo Trading With TradingView And MT5</h1>
                    <div class="d-flex gap-2">
                        <a href="/symbols" class="btn btn-outline-light btn-sm">
                            <i data-feather="trending-up" style="width: 16px; height: 16px;"></i> Symbols
                        </a>
                        <a href="/settings" class="btn btn-outline-light btn-sm">
                            <i data-feather="settings" style="width: 16px; height: 16px;"></i> Settings
                        </a>
                        <a href="/logout" class="btn btn-outline-light btn-sm">
                            <i data-feather="log-out" style="width: 16px; height: 16px;"></i> Logout
                        </a>
                    </div>
                </div>
                <p class="lead mb-4">
                    ‚≠êÔ∏è Access Free TradingView Strategies Exclusively for You!<br>
                    ‚≠êÔ∏è Enjoy Real-time Free Paper Trading with NextLevelBot Style.<br>
                    ‚≠êÔ∏è Trade Anywhere on Any Device - Smartphone to Laptop.<br>
                    ‚≠êÔ∏è Trade Across Multiple MT5 Accounts with No Limits!
                </p>
            </div>
            <div class="col-md-4">
                <div class="nlb-gif-container">
                    <div style="font-size: 4rem;">üí∞</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reality Section - NextLevelBot Style -->
<div class="container">
    <div class="nlb-reality-section">
        <h2 class="text-center mb-4">üéØ Reality Of MT5 Bridge Universe</h2>
        <div class="row">
            <div class="col-md-3 text-center">
                <div class="nlb-counter-card">
                    <div class="nlb-counter-number text-primary">{{ total_users or 1 }}</div>
                    <div class="nlb-counter-label">Total Active Users</div>
                    <small class="text-muted">Not Fake Data</small>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <div class="nlb-counter-card">
                    <div class="nlb-counter-number text-success">{{ total_requests or stats.total_alerts }}</div>
                    <div class="nlb-counter-label">24 Hours API Requests</div>
                    <small class="text-muted">All MT5 Webhook Requests</small>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <div class="nlb-counter-card">
                    <div class="nlb-counter-number text-info">{{ total_accounts or accounts|length }}</div>
                    <div class="nlb-counter-label">Total Trading Accounts</div>
                    <small class="text-muted">In Our Platform</small>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <div class="nlb-counter-card">
                    <div class="nlb-counter-number text-warning">{{ successful_percentage or stats.success_rate }}%</div>
                    <div class="nlb-counter-label">Success Rate</div>
                    <small class="text-muted">Bridge Accuracy</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Multiple Account Management -->
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>üîó Multiple MT5/MT4 Account Connections</h3>
                <a href="/accounts/add" class="btn btn-primary">
                    <i data-feather="plus"></i> Add New Account
                </a>
            </div>
        </div>
    </div>

    {% if accounts %}
    <div class="row">
        {% for account in accounts %}
        <div class="col-md-6 col-lg-4">
            <div class="nlb-account-card card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">{{ account.account_name }}</h6>
                    <span class="badge {% if account.is_connected %}badge-success{% else %}badge-danger{% endif %}">
                        {% if account.is_connected %}
                            <i data-feather="wifi" class="me-1" style="width: 12px; height: 12px;"></i>Online
                        {% else %}
                            <i data-feather="wifi-off" class="me-1" style="width: 12px; height: 12px;"></i>Offline
                        {% endif %}
                    </span>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <small class="text-muted">Account:</small><br>
                            <strong>{{ account.mt5_login }}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Type:</small><br>
                            <span class="badge badge-info">{{ account.broker_type }}</span>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <small class="text-muted">Server:</small><br>
                            <strong>{{ account.mt5_server_ip }}:{{ account.mt5_server_port }}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Trades:</small><br>
                            <span class="text-success">{{ account.successful_trades }}</span> / 
                            <span class="text-danger">{{ account.failed_trades }}</span>
                        </div>
                    </div>

                    <!-- Unique Webhook URL for this account -->
                    <div class="mb-3">
                        <small class="text-muted">Webhook URL:</small>
                        <div class="nlb-webhook-url">
                            /webhook/{{ account.webhook_key }}
                        </div>
                        <small class="text-muted">Use this unique URL in your TradingView alerts for this account</small>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button class="btn btn-sm btn-outline-primary" onclick="testConnection({{ account.id }})">
                            <i data-feather="refresh-cw" style="width: 14px; height: 14px;"></i> Test
                        </button>
                        <a href="/accounts/{{ account.id }}/edit" class="btn btn-sm btn-outline-secondary">
                            <i data-feather="edit" style="width: 14px; height: 14px;"></i> Edit
                        </a>
                        <button class="btn btn-sm btn-outline-info" onclick="getSymbols()">
                            <i data-feather="list" style="width: 14px; height: 14px;"></i> Get Symbols
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAccount({{ account.id }})">
                            <i data-feather="trash-2" style="width: 14px; height: 14px;"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="text-center py-5">
                <i data-feather="plus-circle" style="width: 64px; height: 64px;" class="text-muted mb-3"></i>
                <h4 class="text-muted">No MT5/MT4 Accounts Connected</h4>
                <p class="text-muted">Add your first trading account to start receiving TradingView alerts</p>
                <a href="/accounts/add" class="btn btn-primary btn-lg">
                    <i data-feather="plus"></i> Add Your First Account
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Overview Section -->
<div class="container mt-5">
    <div class="nlb-overview-card">
        <h3 class="mb-3">üåü NextLevelBot Style Overview</h3>
        <p class="mb-3">
            Your MT5 Bridge is India's most advanced API Bridge (automated) Platform, offering seamless 
            integration of TradingView alerts through unique Webhook systems. Built on reliable infrastructure, 
            eliminating the need for any Cloud, VPS, or RDP servers.
        </p>
        <div class="row">
            <div class="col-md-6">
                <h5>‚úÖ Features:</h5>
                <ul>
                    <li>Multiple MT5/MT4 account support</li>
                    <li>Unique webhook URL per account</li>
                    <li>Real-time trade execution</li>
                    <li>Professional dashboard monitoring</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h5>üöÄ Advantages:</h5>
                <ul>
                    <li>No monthly subscription fees</li>
                    <li>Direct MT5 connection (low latency)</li>
                    <li>Complete source code control</li>
                    <li>Self-hosted security</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
{% if recent_alerts %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="activity"></i> Recent TradingView Alerts
                    </h5>
                </div>
                <div class="card-body">
                    {% for alert in recent_alerts[:5] %}
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div>
                            <strong>{{ alert.symbol }}</strong> - {{ alert.action }}
                            {% if alert.trading_account %}
                                <span class="badge badge-secondary ms-2">{{ alert.trading_account.account_name }}</span>
                            {% endif %}
                            <br><small class="text-muted">{{ alert.received_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                        </div>
                        <span class="badge {% if alert.status == 'PROCESSED' %}badge-success{% else %}badge-danger{% endif %}">
                            {{ alert.status }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Symbols Modal -->
<div class="modal fade" id="symbolsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i data-feather="trending-up" style="width: 20px; height: 20px;" class="me-2"></i>
                    MT5 Trading Symbols
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="symbolsModalBody">
                <!-- Symbols will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="getSymbols()">
                    <i data-feather="refresh-cw" style="width: 14px; height: 14px;"></i> Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function testConnection(accountId) {
    fetch(`/api/accounts/${accountId}/test`, {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ Connection successful!');
                location.reload();
            } else {
                alert('‚ùå Connection failed: ' + data.message);
            }
        });
}

// Get Symbols popup functionality
function getSymbols() {
    const modal = new bootstrap.Modal(document.getElementById('symbolsModal'));
    modal.show();
    
    // Show loading
    document.getElementById('symbolsModalBody').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading symbols...</span>
            </div>
            <p class="mt-2">Fetching MT5 symbols...</p>
        </div>
    `;
    
    // Fetch symbols from API
    fetch('/api/symbols')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                displaySymbolsList(data.symbols, data.connection_status);
            } else {
                showSymbolsError(data.message || 'Failed to fetch symbols');
            }
        })
        .catch(error => {
            showSymbolsError('Network error: ' + error.message);
        });
}

function displaySymbolsList(symbols, isConnected) {
    const connectionBadge = isConnected 
        ? '<span class="badge bg-success"><i data-feather="wifi" style="width: 12px; height: 12px;"></i> Connected</span>'
        : '<span class="badge bg-danger"><i data-feather="wifi-off" style="width: 12px; height: 12px;"></i> Disconnected</span>';
    
    let symbolsHtml = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Available MT5 Symbols (${symbols.length} total)</h6>
            ${connectionBadge}
        </div>
        <div class="row">
    `;
    
    symbols.forEach((symbol, index) => {
        symbolsHtml += `
            <div class="col-md-6 mb-2">
                <div class="card border border-primary" style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong style="color: #2c3e50; font-size: 1.1rem;">${symbol.name}</strong>
                                <br><small style="color: #6c757d; font-weight: 500;">${symbol.currency_base}/${symbol.currency_profit}</small>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="copySymbol('${symbol.name}')" title="Copy symbol name" style="background: linear-gradient(135deg, #007bff, #0056b3); border: none;">
                                <i data-feather="copy" style="width: 12px; height: 12px;"></i> Copy
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    symbolsHtml += `
        </div>
        <div class="mt-3 text-center">
            <small class="text-muted">Click the Copy button next to any symbol to copy its name</small>
        </div>
    `;
    
    document.getElementById('symbolsModalBody').innerHTML = symbolsHtml;
    feather.replace(); // Re-initialize feather icons
}

function showSymbolsError(message) {
    document.getElementById('symbolsModalBody').innerHTML = `
        <div class="alert alert-warning text-center">
            <i data-feather="alert-triangle" style="width: 24px; height: 24px;" class="mb-2"></i>
            <h6>Unable to Fetch Symbols</h6>
            <p class="mb-2">${message}</p>
            <small class="text-muted">Please check your MT5 connection in the settings.</small>
        </div>
    `;
    feather.replace();
}

function copySymbol(symbolName) {
    // Copy symbol name to clipboard
    navigator.clipboard.writeText(symbolName).then(function() {
        // Show success feedback
        const event = new CustomEvent('symbolCopied', { detail: symbolName });
        document.dispatchEvent(event);
        
        // Visual feedback
        showToast(`Symbol "${symbolName}" copied to clipboard!`, 'success');
    }).catch(function(err) {
        console.error('Could not copy text: ', err);
        showToast('Failed to copy symbol', 'error');
    });
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i data-feather="${type === 'success' ? 'check-circle' : 'alert-circle'}" style="width: 16px; height: 16px;" class="me-1"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    // Add to page
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    toastContainer.appendChild(toast);
    
    // Initialize and show toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Replace feather icons
    feather.replace();
    
    // Remove after it's hidden
    toast.addEventListener('hidden.bs.toast', function () {
        toast.remove();
    });
}

function deleteAccount(accountId) {
    if (confirm('Are you sure you want to delete this account? This action cannot be undone.')) {
        fetch(`/accounts/${accountId}/delete`, {method: 'POST'})
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to delete account. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting account. Please try again.');
            });
    }
}

// Auto-refresh every 30 seconds
setInterval(() => {
    location.reload();
}, 30000);
</script>
{% endblock %}